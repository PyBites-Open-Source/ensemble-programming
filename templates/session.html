{% extends "base.html" %}

{% block title %}Live Coding Session{% endblock %}

{% block content %}
<div class="grid grid-cols-2 gap-6">
    <!-- Left Column: Code Editor -->
    <div class="bg-white shadow-md p-6 rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Shared Code Editor</h2>
      <textarea id="code-editor"></textarea>

      <form hx-post="/run-code/" hx-target="#output" hx-trigger="submit">
        <input type="hidden" name="code" id="code-input">
        <button type="submit" class="bg-indigo-500 text-white font-semibold px-4 py-2 mt-4 rounded-md"
            onclick="document.getElementById('code-input').value = editor.getValue()">
            Run Code
        </button>
      </form>

      <pre id="output" class="mt-4 p-4 rounded-md"></pre>

    </div>

    <!-- Right Column: Role Rotation & Timer -->
    <div class="bg-white shadow-md p-6 rounded-lg">
        <h2 class="text-xl font-semibold mb-4">Role & Timer</h2>
        <p id="role" class="text-lg font-medium">Current Role: <span class="text-indigo-600">Driver</span></p>
        <p id="timer" class="text-lg mt-2">Time Remaining: <span class="text-red-600">05:00</span></p>
    </div>
</div>

<script>
    var session_id = "{{ session_id }}";
    var ws = new WebSocket("ws://" + location.host + "/ws/" + session_id);
    var editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
        mode: "python",
        theme: "default",
        lineNumbers: true,
        viewportMargin: Infinity,
        indentUnit: 4,
        tabSize: 4,
        indentWithTabs: false,
        lineWrapping: true,
        smartIndent: true
    });
    var isUpdatingFromServer = false;
    ws.onmessage = function(event) {
        if (editor.getValue() !== event.data) {
            isUpdatingFromServer = true;
            editor.setValue(event.data);
            isUpdatingFromServer = false;
        }
    };

    editor.on("change", function(cm) {
        if (!isUpdatingFromServer) {
            ws.send(cm.getValue());
        }
    });

    // Simple 5-min countdown timer
    var countdown = 300;
    function updateTimer() {
        var minutes = Math.floor(countdown / 60);
        var seconds = countdown % 60;
        document.getElementById("timer").innerHTML = `Time Remaining: <span class="text-red-600">${minutes}:${seconds.toString().padStart(2, '0')}</span>`;
        if (countdown > 0) {
            countdown--;
            setTimeout(updateTimer, 1000);
        } else {
            document.getElementById("role").innerHTML = `Current Role: <span class="text-green-600">Navigator</span>`;
        }
    }
    updateTimer();

    document.body.addEventListener("htmx:afterRequest", function(evt) {
        if (evt.detail.target.id === "output") {
            const response = evt.detail.xhr.responseText;
            try {
                const parsed = JSON.parse(response);
                document.getElementById("output").innerText =
                    "Stdout:\n" + parsed.stdout + "\n\nStderr:\n" + parsed.stderr;
            } catch (error) {
                document.getElementById("output").innerText = "Error parsing response";
            }
        }
    });
</script>
{% endblock %}
