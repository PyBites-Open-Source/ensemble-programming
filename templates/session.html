{% extends "base.html" %}

{% block title %}Live Coding Session{% endblock %}

{% block content %}
<div class="grid grid-cols-2 gap-6">
    <!-- Left Column: Code Editor -->
    <div class="bg-white shadow-md p-6 rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Shared Code Editor</h2>
      <textarea id="code-editor"></textarea>

      <form hx-post="/run-code/" hx-target="#output" hx-trigger="submit">
        <input type="hidden" name="code" id="code-input">
        <button type="submit" class="bg-indigo-500 text-white font-semibold px-4 py-2 mt-4 rounded-md"
            onclick="document.getElementById('code-input').value = editor.getValue()">
            Run Code
        </button>
      </form>

      <pre id="output" class="mt-4 p-4 rounded-md"></pre>

    </div>

    <!-- Right Column: Role Rotation & Timer -->
    <div class="bg-white shadow-md p-6 rounded-lg">
      <h2 class="text-xl font-semibold mb-4">Role & Timer</h2>
      <p id="role" class="text-lg font-medium">Current Role: <span id="role-name" class="text-indigo-600">Driver</span></p>
      <p id="timer" class="text-lg mt-2">Time Remaining: <span id="time-remaining" class="text-red-600">&nbsp;</span></p>
    </div>

</div>

<script>
  let session_id = "{{ session_id }}";
  let ws = new WebSocket("ws://" + location.host + "/ws/" + session_id);
  let timerWS = new WebSocket("ws://" + location.host + "/ws/timer/" + session_id);

  timerWS.onmessage = function(event) {
    let message = JSON.parse(event.data);

    if (message.type === "timer") {
        let seconds = message.time;
        let minutes = Math.floor(seconds / 60);
        let remainingSeconds = seconds % 60;
        document.getElementById("time-remaining").textContent =
            `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
  };

  let editor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
      mode: "python",
      theme: "default",
      lineNumbers: true,
      viewportMargin: Infinity,
      indentUnit: 4,
      tabSize: 4,
      indentWithTabs: false,
      lineWrapping: true,
      smartIndent: true
  });
  let isUpdatingFromServer = false;
  ws.onmessage = function(event) {
      if (editor.getValue() !== event.data) {
          isUpdatingFromServer = true;
          editor.setValue(event.data);
          isUpdatingFromServer = false;
      }
  };

  editor.on("change", function(cm) {
      if (!isUpdatingFromServer) {
          ws.send(cm.getValue());
      }
  });

  document.body.addEventListener("htmx:afterRequest", function(evt) {
      if (evt.detail.target.id === "output") {
          const response = evt.detail.xhr.responseText;
          try {
              const parsed = JSON.parse(response);
              document.getElementById("output").innerText =
                  "Stdout:\n" + parsed.stdout + "\n\nStderr:\n" + parsed.stderr;
          } catch (error) {
              document.getElementById("output").innerText = "Error parsing response";
          }
      }
  });
</script>
{% endblock %}
